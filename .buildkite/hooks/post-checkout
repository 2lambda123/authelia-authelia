#!/bin/bash

set +u

echo "--- :buildkite: Setting up Build environment"

export CI=true
export GOPATH=/srv/docker/.buildkite/gopath
export GOROOT=/usr/local/go
export GOMOD=$GOPATH/src/github.com/clems4ever/authelia/go.mod
export NVM_DIR="$HOME/.nvm"
export PATH=$PATH:/usr/local/go/bin
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
nvm use v12
if [[ $BUILDKITE_COMMAND != "" ]]; then
  source bootstrap.sh
elif [[ $BUILDKITE_COMMAND == ".buildkite/steps/buildandtest.sh" ]] || [[ $BUILDKITE_COMMAND == ".buildkite/steps/e2etests.sh | buildkite-agent pipeline upload" ]]; then
  go mod download
elif [[ $BUILDKITE_COMMAND =~ ^xvfb-run ]]; then
  chown -R 1000:1000 $GOPATH
else
  echo "Not running CI"
fi
